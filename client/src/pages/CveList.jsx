import React from "react";
import "../css/CveList.css";
import config from "../configuration/config";
import { useNavigate } from "react-router-dom";

const CveList = () => {
    // const [resultsPerPage , setResultsPerPage] = useEffect(10) ;
    // const [currentPage , setCurrentPage] = useEffect(1) ;
    const [skip, setSkip] = React.useState(0);
    // const [data, setData] = React.useState(null);
    // i am using the below to get suggestions while typing
    const [data, setData] = React.useState({
        _id: "",
        cveId: "",
        sourceIdentifier: "",
        published: "",
        lastModified: "",
        accessComplexity: "",
        accessVector: "",
        authentication: "",
        availabilityImpact: "",
        baseScore: "",
        baseSeverity: "",
        confidentialityImpact: "",
        cpeMatch: [
            { vulnerable: "", criteria: "", matchCriteriaId: "" },
            { vulnerable: "", criteria: "", matchCriteriaId: "" },
        ],
        descriptions: [
            { lang: "", value: "" },
            { lang: "", value: "" },
        ],
        exploitabilityScore: "",
        impactScore: "",
        integrityImpact: "",
        vectorString: "",
        vulnStatus: "",
        __v: 0,
    });
    const [resultsPerPage, setResultsPerPage] = React.useState(10);
    const [totalRecords, setTotalRecords] = React.useState(0);

    //Instead of using regular link tag, i am using this
    const navigate = useNavigate();

    React.useEffect(() => {
        fetch(`http://localhost:${config.backendPort}/totalCveCount`)
            .then((response) => response.json())
            .then((res) => {
                console.log("HIIIIIII");
                console.log(res);
                setTotalRecords(res);
            })
            .catch((error) => {
                console.error("Error fetching total records:", error);
            });
    }, []);

    React.useEffect(() => {
        fetch(
            `http://localhost:${config.backendPort}/cveList?count=${resultsPerPage}&offset=${skip}`
        )
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                setData(data);
            })
            .catch((error) => {
                console.error("Error fetching CVE data:", error);
            });
    }, [skip, resultsPerPage]);

    const handlePlus = () => {
        setSkip(skip + 10);
    };

    const handleMinus = () => {
        if (skip > 0) {
            setSkip(skip - 10);
        }
    };

    //The below works similar to the Link or the Anchor tag, but i am using react-router-dom
    const handleNavigationToSingleCve = (cveId) => {
        navigate(`/singleCve/${cveId}`);
    };

    return (
        <>
            <p>Total records:{totalRecords}</p>
            {data !== null && data.length > 0 && (
                <table>
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>Source Identifier</th>
                            <th>Published</th>
                            <th>Last Modified</th>
                            <th>Vulnerability Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map(
                            (
                                //Just for the sake of getting the suggestions i am using the below
                                item = {
                                    _id: "",
                                    cveId: "",
                                    sourceIdentifier: "",
                                    published: "",
                                    lastModified: "",
                                    accessComplexity: "",
                                    accessVector: "",
                                    authentication: "",
                                    availabilityImpact: "",
                                    baseScore: "",
                                    baseSeverity: "",
                                    confidentialityImpact: "",
                                    cpeMatch: [
                                        { vulnerable: "", criteria: "", matchCriteriaId: "" },
                                        { vulnerable: "", criteria: "", matchCriteriaId: "" },
                                    ],
                                    descriptions: [
                                        { lang: "", value: "" },
                                        { lang: "", value: "" },
                                    ],
                                    exploitabilityScore: "",
                                    impactScore: "",
                                    integrityImpact: "",
                                    vectorString: "",
                                    vulnStatus: "",
                                    __v: 0,
                                }
                            ) => (
                                //The below onclick event deals with the naviation from the cve list to the single cve page
                                <tr
                                    key={item._id}
                                    onClick={() => {
                                        handleNavigationToSingleCve(item.cveId);
                                    }}
                                >
                                    <td>{item.cveId}</td>
                                    <td>{item.sourceIdentifier}</td>
                                    <td>{item.published}</td>
                                    <td>{item.lastModified}</td>
                                    <td>{item.vulnStatus}</td>
                                </tr>
                            )
                        )}
                    </tbody>
                </table>
            )}
            <div className="button-container">
                <select
                    name=""
                    id=""
                    onChange={(event) => {
                        console.log("Event:", event);
                        setResultsPerPage(event.target.value);
                    }}
                >
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="3000">3000</option>
                </select>

                <button onClick={handleMinus}>prev page</button>
                <span className="page-number">{skip / 10 + 1}</span>
                <button onClick={handlePlus}>next page</button>
            </div>
            {data !== null && data.length === 0 && (
                <p className="message">No data available</p>
            )}
        </>
    );
};

export default CveList;
